From 4344b9cfca346406a0fe11a2cb59a45eb1f5404c Mon Sep 17 00:00:00 2001
From: Rafael Palomar <rafael.palomar@ous-research.no>
Date: Mon, 20 Mar 2023 17:50:49 +0100
Subject: [PATCH 2/2] ENH: Enable install tree

---
 CMake/GenerateIGSIOConfig.cmake | 20 +++++++++++++++++--
 CMake/IGSIOMacros.cmake         | 10 +++++++---
 CMakeLists.txt                  | 34 ++++++++++++++++++++++++++++-----
 IGSIOCalibration/CMakeLists.txt |  2 +-
 IGSIOCommon/CMakeLists.txt      |  9 +++++++++
 IGSIOInstallConfig.cmake.in     | 34 +++++++++++++++++++++++++++++++++
 SequenceIO/CMakeLists.txt       |  9 +++++++++
 7 files changed, 107 insertions(+), 11 deletions(-)
 create mode 100644 IGSIOInstallConfig.cmake.in

diff --git a/CMake/GenerateIGSIOConfig.cmake b/CMake/GenerateIGSIOConfig.cmake
index b3f199a..0b67e4d 100644
--- a/CMake/GenerateIGSIOConfig.cmake
+++ b/CMake/GenerateIGSIOConfig.cmake
@@ -14,12 +14,28 @@ SET(VTKSEQUENCEIO_INCLUDE_DIRS_CONFIG ${vtkSequenceIO_INCLUDE_DIRS})
 SET(VTKIGSIOCOMMON_INCLUDE_DIRS_CONFIG ${vtkIGSIOCommon_INCLUDE_DIRS})
 # vtkVolumeReconstruction
 SET(VTKVOLUMERECONSTRUCTION_INCLUDE_DIRS_CONFIG ${vtkVolumeReconstruction_INCLUDE_DIRS})
-
 # vtkIGSIOCalibration
 SET(VTKIGSIOCALIBRATION_INCLUDE_DIRS_CONFIG ${vtkIGSIOCalibration_INCLUDE_DIRS})
-
 # The library dependencies file.
 SET(IGSIO_LIBRARY_TARGETS_FILE_CONFIG ${IGSIO_BINARY_DIR}/IGSIOTargets.cmake)
 
 CONFIGURE_FILE(${IGSIO_SOURCE_DIR}/IGSIOConfig.cmake.in
                ${IGSIO_BINARY_DIR}/IGSIOConfig.cmake @ONLY IMMEDIATE)
+
+
+#-----------------------------------------------------------------------------
+# Configure igsioConfig.cmake (install version)
+
+# vtkSequenceIO
+SET(VTKSEQUENCEIO_INSTALL_INCLUDE_DIRS_CONFIG ${IGSIO_INSTALL_INCLUDE_DIR})
+# vtkIGSIOCommon
+SET(VTKIGSIOCOMMON_INSTALL_INCLUDE_DIRS_CONFIG ${IGSIO_INSTALL_INCLUDE_DIR})
+# vtkVolumeReconstruction
+SET(VTKVOLUMERECONSTRUCTION_INSTALL_INCLUDE_DIRS_CONFIG ${IGSIO_INSTALL_INCLUDE_DIR})
+# vtkIGSIOCalibration
+SET(VTKIGSIOCALIBRATION_INCLUDE_INSTALL_DIRS_CONFIG ${vtkIGSIOCalibration_INCLUDE_DIRS})
+
+# The library dependencies file.
+SET(IGSIO_LIBRARY_TARGETS_FILE_CONFIG ${IGSIO_INSTALL_CMAKE_DIR}/IGSIOTargets.cmake)
+CONFIGURE_FILE(${IGSIO_SOURCE_DIR}/IGSIOInstallConfig.cmake.in
+               ${IGSIO_BINARY_DIR}/install/IGSIOConfig.cmake @ONLY IMMEDIATE)
diff --git a/CMake/IGSIOMacros.cmake b/CMake/IGSIOMacros.cmake
index 6d717de..6889483 100644
--- a/CMake/IGSIOMacros.cmake
+++ b/CMake/IGSIOMacros.cmake
@@ -12,9 +12,13 @@ MACRO(IGSIOInstallLibrary _target_name _variable_root)
     LIBRARY DESTINATION "${IGSIO_INSTALL_LIB_DIR}" CONFIGURATIONS ${CONFIG} COMPONENT RuntimeLibraries
     ARCHIVE DESTINATION "${IGSIO_INSTALL_ARCHIVE_DIR}" CONFIGURATIONS ${CONFIG} COMPONENT Development
     )
-  INSTALL(FILES ${${_variable_root}_HDRS}
-    DESTINATION "${IGSIO_INCLUDE_INSTALL}" COMPONENT Development
+
+  IF(NOT IGSIO_NO_DEVELOPMENT_INSTALL)
+    INSTALL(FILES ${${_variable_root}_HDRS}
+      DESTINATION "${IGSIO_INSTALL_INCLUDE_DIR}" COMPONENT Development
     )
+
+  ENDIF()
   GET_TARGET_PROPERTY(_library_type ${_target_name} TYPE)
   IF(${_library_type} STREQUAL SHARED_LIBRARY AND MSVC)
     INSTALL(FILES "$<TARGET_PDB_FILE:${_target_name}>" OPTIONAL
@@ -123,6 +127,6 @@ MACRO(GENERATE_EXPORT_DIRECTIVE_FILE LIBRARY_NAME)
     )
   INSTALL(FILES 
     ${CMAKE_CURRENT_BINARY_DIR}/${MY_EXPORT_HEADER_PREFIX}Export.h
-    DESTINATION "${IGSIO_INCLUDE_INSTALL}"
+    DESTINATION "${IGSIO_INSTALL_INCLUDE_DIR}"
     )
 ENDMACRO()
diff --git a/CMakeLists.txt b/CMakeLists.txt
index cc213d2..80a4cf7 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -16,6 +16,10 @@ SET(CMAKE_MODULE_PATH
   ${CMAKE_MODULE_PATH}
   )
 
+IF(NOT DEFINED IGSIO_NO_DEVELOPMENT_INSTALL)
+  SET(IGSIO_NO_DEVELOPMENT_INSTALL ON)
+ENDIF()
+
 # --------------------------------------------------------------------------
 # System Settings
 IF(WIN32)
@@ -50,13 +54,21 @@ IF(NOT IGSIO_INSTALL_LIB_DIR)
   SET(IGSIO_INSTALL_LIB_DIR "lib")
 ENDIF()
 
-IF(NOT IGSIO_INSTALL_DATA_DIR)
-  SET(IGSIO_INSTALL_DATA_DIR "share")
+IF(NOT IGSIO_INSTALL_SHARE_DIR)
+  SET(IGSIO_INSTALL_SHARE_DIR "share")
 ENDIF()
 
 SET(IGSIO_INSTALL_FOLDERNAME "IGSIO-${IGSIO_VERSION_MAJOR}.${IGSIO_VERSION_MINOR}")
-IF(NOT IGSIO_INCLUDE_INSTALL )
-  SET(IGSIO_INCLUDE_INSTALL "include/${IGSIO_INSTALL_FOLDERNAME}")
+IF(NOT IGSIO_INSTALL_INCLUDE_DIR )
+  SET(IGSIO_INSTALL_INCLUDE_DIR "include/${IGSIO_INSTALL_FOLDERNAME}")
+ENDIF()
+
+IF(NOT IGSIO_INSTALL_DATA_DIR)
+  SET(IGSIO_INSTALL_DATA_DIR "${IGSIO_INSTALL_SHARE_DIR}/data")
+ENDIF()
+
+IF(NOT IGSIO_INSTALL_CMAKE_DIR)
+  SET(IGSIO_INSTALL_CMAKE_DIR "${IGSIO_INSTALL_SHARE_DIR}/${IGSIO_INSTALL_FOLDERNAME}/cmake")
 ENDIF()
 
 IF(NOT DEFINED BUILD_SHARED_LIBS)
@@ -179,8 +191,8 @@ ELSE()
   endif()
   unset(_igsio_targets)
 
-  # Create an IGSIOConfig.cmake and IGSIOConfig Version.cmake file for the use from the build tree
   #-----------------------------------------------------------------------------
+  # Create an IGSIOConfig.cmake and IGSIOConfig Version.cmake file for the use from the build tree
   INCLUDE(CMakePackageConfigHelpers)
   write_basic_package_version_file(
     "${CMAKE_CURRENT_BINARY_DIR}/IGSIOConfigVersion.cmake"
@@ -189,4 +201,16 @@ ELSE()
   LIST(APPEND IGSIO_INSTALL_CMAKE_FILES} "${CMAKE_CURRENT_BINARY_DIR}/IGSIOConfigVersion.cmake")
   INCLUDE(${CMAKE_SOURCE_DIR}/CMake/GenerateIGSIOConfig.cmake)
 
+  #-----------------------------------------------------------------------------
+  # Install CMake files
+  list(APPEND IGSIO_CMAKE_FILES
+    ${CMAKE_CURRENT_BINARY_DIR}/install/IGSIOConfig.cmake
+  )
+
+  IF(NOT IGSIO_NO_DEVELOPMENT_INSTALL)
+    INSTALL(FILES ${IGSIO_CMAKE_FILES}
+    DESTINATION ${IGSIO_INSTALL_CMAKE_DIR}
+    COMPONENT Development)
+  ENDIF()
+
 ENDIF()
diff --git a/IGSIOCalibration/CMakeLists.txt b/IGSIOCalibration/CMakeLists.txt
index 109f4a0..68cf438 100644
--- a/IGSIOCalibration/CMakeLists.txt
+++ b/IGSIOCalibration/CMakeLists.txt
@@ -31,7 +31,7 @@ ADD_LIBRARY(vtk${PROJECT_NAME} ${${PROJECT_NAME}_SRCS} ${${PROJECT_NAME}_HDRS})
 FOREACH(p IN LISTS ${PROJECT_NAME}_INCLUDE_DIRS)
   target_include_directories(vtk${PROJECT_NAME} PUBLIC $<BUILD_INTERFACE:${p}>)
 ENDFOREACH()
-target_include_directories(vtk${PROJECT_NAME} PUBLIC $<INSTALL_INTERFACE:${IGSIO_INCLUDE_INSTALL}>)
+target_include_directories(vtk${PROJECT_NAME} PUBLIC $<INSTALL_INTERFACE:${IGSIO_INSTALL_INCLUDE_DIR}>)
 TARGET_LINK_LIBRARIES(vtk${PROJECT_NAME} PUBLIC ${${PROJECT_NAME}_LIBS})
 
 SET_PROPERTY(GLOBAL APPEND PROPERTY IGSIO_TARGETS vtk${PROJECT_NAME})
diff --git a/IGSIOCommon/CMakeLists.txt b/IGSIOCommon/CMakeLists.txt
index 6f42202..d1a11ed 100644
--- a/IGSIOCommon/CMakeLists.txt
+++ b/IGSIOCommon/CMakeLists.txt
@@ -94,11 +94,20 @@ TARGET_LINK_LIBRARIES(${PROJECT_NAME}
   PRIVATE ${${PROJECT_NAME}_LIBS_PRIVATE}
   )
 
+#-----------------------------------------------------------------------------
+# Install the library files
 INSTALL(TARGETS ${PROJECT_NAME} EXPORT ${PROJECT_NAME}
   RUNTIME DESTINATION ${IGSIO_INSTALL_BIN_DIR} COMPONENT RuntimeLibraries
   LIBRARY DESTINATION ${IGSIO_INSTALL_LIB_DIR} COMPONENT RuntimeLibraries
   ARCHIVE DESTINATION ${IGSIO_INSTALL_LIB_DIR} COMPONENT Development)
 
+#-----------------------------------------------------------------------------
+# Install the development files
+IF(NOT IGSIO_NO_DEVELOPMENT_INSTALL)
+  FILE(GLOB ${PROJECT_NAME}_HEADERS "*.h")
+  INSTALL(FILES ${${PROJECT_NAME}_HEADERS} DESTINATION ${IGSIO_INSTALL_INCLUDE_DIR})
+ENDIF()
+
 FOREACH(p IN LISTS ${PROJECT_NAME}_INCLUDE_DIRS)
   TARGET_INCLUDE_DIRECTORIES(${PROJECT_NAME} PUBLIC $<BUILD_INTERFACE:${p}>)
 ENDFOREACH()
diff --git a/IGSIOInstallConfig.cmake.in b/IGSIOInstallConfig.cmake.in
new file mode 100644
index 0000000..b9817b7
--- /dev/null
+++ b/IGSIOInstallConfig.cmake.in
@@ -0,0 +1,34 @@
+#-----------------------------------------------------------------------------
+#
+# IGSIOConfig.cmake - IGSIO CMake configuration file for external projects.
+#
+
+# The vtkIGSIOCommon include file directories
+SET(VTKIGSIOCOMMON_INCLUDE_DIRS "@IGSIO_INSTALL_INCLUDE_DIR@")
+
+# The vtkSequenceIO include file directories.
+SET(VTKSEQUENCEIO_INCLUDE_DIRS "@IGSIO_INSTALL_INCLUDE_DIR@")
+
+# The vtkVolumeReconstruction include file directories.
+SET(VTKVOLUMERECONSTRUCTION_INCLUDE_DIRS "@IGSIO_INSTALL_INCLUDE_DIR@")
+
+# The vtkIGSIOCalibration include file directories.
+SET(VTKIGSIOCALIBRATION_INCLUDE_DIRS "@IGSIO_INSTALL_INCLUDE_DIR@")
+
+# SET(VTK_DIR "@VTK_DIR@")
+
+# SET(VP9_DIR "@VP9_DIR@")
+
+# IF (NOT @IGSIO_USE_3DSlicer@)
+#   SET(vtkAddon_DIR "@vtkAddon_DIR@")
+#   FIND_PACKAGE(vtkAddon REQUIRED)
+# ENDIF()
+
+SET(IGSIO_BUILD_SEQUENCEIO "@IGSIO_BUILD_SEQUENCEIO@")
+SET(IGSIO_SEQUENCEIO_ENABLE_MKV "@IGSIO_SEQUENCEIO_ENABLE_MKV@")
+SET(IGSIO_BUILD_VOLUMERECONSTRUCTION "@IGSIO_BUILD_VOLUMERECONSTRUCTION@")
+SET(IGSIO_USE_VP9 "@IGSIO_USE_VP9@")
+
+# The IGSIO library targets.
+SET(IGSIO_LIBRARY_TARGETS_FILE "@IGSIO_LIBRARY_TARGETS_FILE_CONFIG@")
+INCLUDE(${IGSIO_LIBRARY_TARGETS_FILE})
diff --git a/SequenceIO/CMakeLists.txt b/SequenceIO/CMakeLists.txt
index 34cddbd..5ba52b0 100644
--- a/SequenceIO/CMakeLists.txt
+++ b/SequenceIO/CMakeLists.txt
@@ -79,11 +79,20 @@ TARGET_LINK_LIBRARIES(${PROJECT_NAME}
   PRIVATE ${${PROJECT_NAME}_LIBS_PRIVATE}
   )
 
+#-----------------------------------------------------------------------------
+# Install the library files
 INSTALL(TARGETS ${PROJECT_NAME} EXPORT ${PROJECT_NAME}
   RUNTIME DESTINATION ${IGSIO_INSTALL_BIN_DIR} COMPONENT RuntimeLibraries
   LIBRARY DESTINATION ${IGSIO_INSTALL_LIB_DIR} COMPONENT RuntimeLibraries
   ARCHIVE DESTINATION ${IGSIO_INSTALL_LIB_DIR} COMPONENT Development)
 
+#-----------------------------------------------------------------------------
+# Install the development files
+IF(NOT IGSIO_NO_DEVELOPMENT_INSTALL)
+  FILE(GLOB ${PROJECT_NAME}_HEADERS "*.h")
+  INSTALL(FILES ${${PROJECT_NAME}_HEADERS} DESTINATION ${IGSIO_INSTALL_INCLUDE_DIR})
+ENDIF()
+
 FOREACH(p IN LISTS ${PROJECT_NAME}_INCLUDE_DIRS)
   TARGET_INCLUDE_DIRECTORIES(${PROJECT_NAME} PUBLIC $<BUILD_INTERFACE:${p}>)
 ENDFOREACH()
-- 
2.39.2

